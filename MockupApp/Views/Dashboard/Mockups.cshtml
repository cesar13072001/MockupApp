
@{
    ViewBag.Title = "Mockups";
    Layout = "~/Views/Shared/_Dashboard.cshtml";
}

<h2>Mockups</h2>
<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item"><a href="index.html">Resumen</a></li>
    <li class="breadcrumb-item active">Mockups</li>
</ol>


<!-- Button trigger modal -->
<button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#exampleModal">
    Agregar
</button>
<br />
<br />
<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Agregar mockup</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="post" enctype="multipart/form-data" action="javascript:agregarMockup()">

                <div class="modal-body">

                    <div class="row">

                        <div class="mb-3">
                            <label for="txtTitulo" class="form-label">Titulo</label>
                            <input type="text" class="form-control" id="txtTitulo">
                        </div>
                        <div class="mb-3">
                            <label for="txtDescripcion" class="form-label">Descripcion</label>
                            <textarea class="form-control" id="txtDescripcion" rows="2"></textarea>
                        </div>

                        <div class="mb-3 col-6">
                            <label for="txtPrecio" class="form-label">Precio</label>
                            <input type="number" class="form-control" id="txtPrecio">
                        </div>

                        <div class="mb-3 col-6">
                            <label for="txtDescuento" class="form-label">Descuento</label>
                            <input type="number" class="form-control" id="txtDescuento">
                        </div>



                        <div class="mb-4 mt-2 col-10">
                            <label for="formPSD" class="form-label">Archivo PSD</label>
                            <input class="form-control" type="file" id="formPSD">
                        </div>

                        <div class="col-2 mb-1 text-start pt-4">

                            <div class="">
                                <a href="#" title="Archivo .psd"><i class="fa fa-file-powerpoint fa-3x" style="color:black;"></i></a>
                            </div>

                        </div>


                        <div class="mb-2">
                            <label for="formFoto" class="form-label">Foto</label>
                            <input class="form-control" type="file" id="formFoto">
                        </div>


                        <div class="mb-1">
                            <div class="rounded-2 text-center" style="height: auto;">
                                <a href="#" title="foto">
                                    <img class="h-50 w-50" id="imgFoto" src="https://res.cloudinary.com/dl1mbt9jb/image/upload/v1691258557/recursos/image.png" />
                                </a>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row mt-3" id="guardando">
                        <div class="spinner-border text-dark col-3" role="status">
                            <span class="visually-hidden"></span>
                        </div>
                        <div class="col-9 mt-1"><p>Guardando</p></div>
                    </div>

                    <button type="submit" class="btn btn-dark">Agregar</button>

                </div>

            </form>
        </div>
    </div>
</div>


<table class="table" id="tabla" style="width: 100%;">
    <thead>
        <tr style="width:100%">
            <th>Id</th>
            <th>Titulo</th>
            <th>Precio</th>
            <th>Descuento(%)</th>
            <th>Precio descuento</th>
            <th>Estado</th>
            <th>Acción</th>
            <th></th>
            <th></th>
            
        </tr>
    </thead>

</table>


@section scripts{
    <script>

        var tabledata;


        llenarTabla();



         function buscarProducto(id) {


            jQuery.ajax({

                url: '@Url.Action("buscarMockup", "Dashboard")',

                type: "POST",
                data: JSON.stringify({id : id}),

                dataType: "json",

                contentType: "application/json; charset=utf-8",


                success: function (data) {


                    console.log(data);

                },
                error: function (error) {
                    console.log(error);
                },
                beforeSend: function () {

                }
            });

        }






        function llenarTabla() {

            tabledata = new DataTable('#tabla', {
                scrollX: true,
                scrollY: true,
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.16/i18n/Spanish.json"
                },
                "ajax": {
                    url: '@Url.Action("listarMockup", "Dashboard")',
                    type: "GET",
                    dataType: "json",
                    beforeSend: function (data) {
                        /*productos = data;
                        console.log(productos);*/
                    }

                },
                "columns": [
                    { "data": "idProducto", },
                    { "data": "titulo", },
                    { "data": "precio", },
                    { "data": "descuento", },
                    { "data": "precioDescuento", },

                    {
                        "data": "estado", "render":
                            function (valor) {
                                if (valor == true) {
                                    return valor
                                    //`<div class="form-check form-switch">
                                    //<input title="Activo" class="form-check-input" type="checkbox" role="switch" id="switchActivo" checked>
                                    //</div>`
                                }
                                if (valor == false) {
                                    return valor
                                    //`<div class="form-check form-switch">
                                    //<input title="Inactivo" class="form-check-input" type="checkbox" role="switch" id="switchActivo">
                                    //</div>`

                                }
                            }
                    },
                    {
                        "defaultContent": '<button type="button" title="Detalles" class="btn btn-success btn-ver"><i class="fas fa-eye"></i></button> ',
                        "orderable": false,
                        "searchable": false,
                        "width": "50px",
                    },
                    {
                        "defaultContent": '<button type="button" title="Editar" class="btn btn-primary btn-editar"><i class="fas fa-pen"></i></button> ',
                        "orderable": false,
                        "searchable": false,
                        "width": "50px",
                    },
                    {
                        "defaultContent": '<button type="button" title="Eliminar" class="btn btn-danger btn-eliminar"><i class="fas fa-trash"></i></button>',
                        "orderable": false,
                        "searchable": false,
                        "width": "50px",
                    },
                ]
            });



        }




        function agregarMockup() {
            var formData = new FormData();
            formData.append("titulo", $("#txtTitulo").val());
            formData.append("descripcion", $("#txtDescripcion").val());
            formData.append("precio", $("#txtPrecio").val());
            formData.append("descuento", $("#txtDescuento").val());
            formData.append("psd", $("#formPSD")[0].files[0]);
            formData.append("foto", $("#formFoto")[0].files[0]);

            jQuery.ajax({
                //Establecemos el url como el JSONResult de nuestro controlador
                url: '@Url.Action("guardarMockup", "Dashboard")',
                //Indicamos que tipo de peticion es
                type: "POST",
                data: formData,
                //Indicamos el tipo de dato a traer
                dataType: "json",
                //Indicamos el tipo de contenido asi como el charset
                contentType: "application/json; charset=utf-8",
                //acciones a tomar cuando la data es traida de manera correcta
                processData: false,
                contentType: false,
                async: false,
                success: function (data) {

                    /*document.getElementById("mensajeAlerta").innerHTML = "Cuenta creada correctamente";
                    $("#liveToast").show();

                    setTimeout(() => {
                        $("#liveToast").hide();

                        location.href = "/login";
                        $("#txtNombres").val("");
                        $("#txtApellidos").val("");
                        $("#txtCorreo").val("");
                        $("#txtContrasenia").val("");
                    }, 3000);*/

                    console.log(data);

                },
                error: function (error) {
                    console.log(error);
                },
                beforeSend: function () {

                }
            });
        }



        $("#tabla tbody").on("click", ".btn-ver", function () {
            var filaSeleccionada =  $(this).closest("tr");
            let idProducto = tabledata.row(filaSeleccionada).data()["idProducto"];
            console.log(idProducto);
            var data = buscarProducto(idProducto);

        });


        $("#tabla tbody").on("click", ".btn-editar", function () {
            var filaSeleccionada = $(this).closest("tr");
            let idProducto = tabledata.row(filaSeleccionada).data()["idProducto"];
            console.log(idProducto);
            var data = buscarProducto(idProducto);

        });


        $("#tabla tbody").on("click", ".btn-eliminar", function () {
            var filaSeleccionada = $(this).closest("tr");
            let idProducto = tabledata.row(filaSeleccionada).data()["idProducto"];
            //console.log(idProducto);
            //var data = buscarProducto(idProducto);
            eliminarMockup(idProducto);

        });


        function eliminarMockup(id) {
            jQuery.ajax({

                url: '@Url.Action("eliminarMockup", "Dashboard")',

                type: "POST",
                data: JSON.stringify({ id: id}),

                dataType: "json",

                contentType: "application/json; charset=utf-8",

                success: function (data) {

                    console.log(data);

                },
                error: function (error) {
                    console.log(error);
                },
                beforeSend: function () {

                }
            });
        }



        $("#tabla tbody").on("change", "#switchActivo", function () {
            var filaSeleccionada = $(this).closest("tr");


            let idProducto = tabledata.row(filaSeleccionada).data()["idProducto"];

            var checked = this.checked;
            if (checked) {
                cambiarEstadoMockup(idProducto, true);
                alert(`Activo ${idProducto}`);
            }
            else {
                cambiarEstadoMockup(idProducto, false);
                alert(`Inactivo ${idProducto}`);
            }



        });


        function cambiarEstadoMockup(id, estado) {


            jQuery.ajax({

                url: '@Url.Action("actualizarEstadoMockup", "Dashboard")',

                type: "POST",
                data: JSON.stringify({ id: id, estado: estado }),

                dataType: "json",

                contentType: "application/json; charset=utf-8",

                success: function (data) {

                    console.log(data);

                },
                error: function (error) {
                    console.log(error);
                },
                beforeSend: function () {

                }
            });
        }



        $("#formFoto").on("change", function () {
            var imagen = $(this)[0].files[0];

            var fileReader = new FileReader();
            fileReader.readAsDataURL(imagen);
            fileReader.onload = function () {

                console.log(fileReader.result);
                $("#imgFoto").attr("src", fileReader.result);
            };
        });


    </script>

}